name: Generate Ruby SDK

on:
  workflow_dispatch:

jobs:
  generate-ruby-sdk:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    name: Build Lago Ruby SDK
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Checkout Lago Ruby Repository
        uses: actions/checkout@v3
        with:
          repository: getlago/lago-ruby
          token: ${{ secrets.ACCESS_TOKEN }}
          ref: main
          path: './ruby-client'

      - name: Generate Ruby SDK
        uses: openapi-generators/openapitools-generator-action@v1
        with:
          generator: ruby
          openapi-file: openapi.yaml
          config-file: generators/ruby-config.yaml

      - name: Open PR with changes on Lago Ruby Repository
        run: |
          BRANCH_NAME="new-version"
          COMMIT_MESSAGE="misc: Version v0.45.0-beta"
          # TODO: extract version from openapi file

          # Move into client folder
          cd ruby-client

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Commit and push the changes in a new feature branch
          git checkout -b $BRANCH_NAME
          git commit -a -m $COMMIT_MESSAGE
          git push origin $BRANCH_NAME

          # Store credentials for the Github CLI
          echo "${{ secrets.ACCESS_TOKEN }}" > access_token.txt

          # Authorize GitHub CLI for the current repository and
          # create a pull-requests containing the updates.
          gh auth login --with-token < token.txt
          gh pr create \
            --body "" \
            --title $COMMIT_MESSAGE \
            --head "$BRANCH_NAME" \
            --base "main"
